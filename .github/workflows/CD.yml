name: æ‰‹åŠ¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ (Manual CD)

# æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
on:
  workflow_dispatch:
    inputs:
      confirm_deployment:
        description: 'ç¡®è®¤éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ (è¾“å…¥ "DEPLOY" ç¡®è®¤)'
        required: true
        default: ''

jobs:
  deploy:
    name: éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
    runs-on: ubuntu-latest

    # åªæœ‰è¾“å…¥æ­£ç¡®ç¡®è®¤å­—ç¬¦ä¸²æ‰æ‰§è¡Œéƒ¨ç½²
    if: github.event.inputs.confirm_deployment == 'DEPLOY'

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # 2. è®¾ç½® Node.js ç¯å¢ƒ
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # 3. å®‰è£…ä¾èµ–
      - name: å®‰è£…ä¾èµ–
        run: |
          npm ci
          cd packages/frontend
          npm ci

      # 4. æ„å»ºå‰ç«¯
      - name: æ„å»ºå‰ç«¯é™æ€æ–‡ä»¶
        run: |
          cd packages/frontend
          npm run build

      # 5. æœåŠ¡æ¢æµ‹ - ç™»å½•ç½‘ç«™å¹¶è®¾ç½®ç»´æŠ¤çŠ¶æ€
      - name: è®¾ç½®ç½‘ç«™ä¸ºç»´æŠ¤çŠ¶æ€
        run: |
          echo "æ­£åœ¨ç™»å½•ç½‘ç«™å¹¶è®¾ç½®ç»´æŠ¤çŠ¶æ€..."

          # ç™»å½•è·å–token
          LOGIN_RESPONSE=$(curl -s -X POST "https://pinkprisma.com/api/auth/login" \
            -H "Content-Type: application/json" \
            -d '{
              "email": "${{ secrets.WEBSITE_LOGIN_USERNAME }}",
              "password": "${{ secrets.WEBSITE_LOGIN_PASSWORD }}"
            }')

          # æå–token
          TOKEN=$(echo $LOGIN_RESPONSE | jq -r '.data.token')

          if [ "$TOKEN" = "null" ] || [ -z "$TOKEN" ]; then
            echo "ç™»å½•å¤±è´¥ï¼Œæ— æ³•è·å–token"
            exit 1
          fi

          echo "ç™»å½•æˆåŠŸï¼Œæ­£åœ¨è®¾ç½®ç»´æŠ¤çŠ¶æ€..."

          # è®¾ç½®ç½‘ç«™ä¸ºç»´æŠ¤çŠ¶æ€
          curl -s -X PUT "https://pinkprisma.com/api/manage/service/status" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $TOKEN" \
            -d '{"status": "maintenance"}'
            
          echo "ç½‘ç«™å·²è®¾ç½®ä¸ºç»´æŠ¤çŠ¶æ€"

      # 6. è½®è¯¢æœåŠ¡çŠ¶æ€ï¼Œç­‰å¾…ä»»åŠ¡å®Œæˆ
      - name: ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
        run: |
          echo "æ­£åœ¨ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ..."

          # é‡æ–°ç™»å½•è·å–tokenï¼ˆé˜²æ­¢tokenè¿‡æœŸï¼‰
          LOGIN_RESPONSE=$(curl -s -X POST "https://pinkprisma.com/api/auth/login" \
            -H "Content-Type: application/json" \
            -d '{
              "email": "${{ secrets.WEBSITE_LOGIN_EMAIL }}",
              "password": "${{ secrets.WEBSITE_LOGIN_PASSWORD }}"
            }')

          TOKEN=$(echo $LOGIN_RESPONSE | jq -r '.data.token')

          # è½®è¯¢ç›´åˆ°æ‰€æœ‰ä»»åŠ¡å®Œæˆ
          MAX_WAIT_TIME=300  # æœ€å¤§ç­‰å¾…5åˆ†é’Ÿ
          WAIT_TIME=0

          while [ $WAIT_TIME -lt $MAX_WAIT_TIME ]; do
            # è·å–æœåŠ¡çŠ¶æ€
            STATUS_RESPONSE=$(curl -s -X GET "https://pinkprisma.com/api/manage/service/status" \
              -H "Authorization: Bearer $TOKEN")
            
            PENDING_TASKS=$(echo $STATUS_RESPONSE | jq -r '.data.pendingTasks // 0')
            RUNNING_TASKS=$(echo $STATUS_RESPONSE | jq -r '.data.runningTasks // 0')
            
            echo "å½“å‰çŠ¶æ€: é˜»å¡ä»»åŠ¡=$PENDING_TASKS, è¿è¡Œä¸­ä»»åŠ¡=$RUNNING_TASKS"
            
            # å¦‚æœæ‰€æœ‰ä»»åŠ¡éƒ½å®Œæˆäº†ï¼Œé€€å‡ºå¾ªç¯
            if [ "$PENDING_TASKS" = "0" ] && [ "$RUNNING_TASKS" = "0" ]; then
              echo "æ‰€æœ‰ä»»åŠ¡å·²å®Œæˆï¼Œå¯ä»¥å¼€å§‹éƒ¨ç½²"
              break
            fi
            
            echo "ç­‰å¾…ä»»åŠ¡å®Œæˆä¸­... (å·²ç­‰å¾… ${WAIT_TIME}s)"
            sleep 10
            WAIT_TIME=$((WAIT_TIME + 10))
          done

          if [ $WAIT_TIME -ge $MAX_WAIT_TIME ]; then
            echo "ç­‰å¾…è¶…æ—¶ï¼Œä½†ç»§ç»­éƒ¨ç½²"
          fi

      # 7. SSHè¿æ¥æœåŠ¡å™¨å¹¶åœæ­¢æœåŠ¡
      - name: åœæ­¢æœåŠ¡å™¨ä¸Šçš„DockeræœåŠ¡
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 47.102.108.122
          username: root
          key: ${{ secrets.SERVER_SSH_PRIVATE_KEY }}
          script: |
            echo "æ­£åœ¨åœæ­¢DockeræœåŠ¡..."
            cd /opt/prisma-ai-hub-deploy

            # åœæ­¢æ‰€æœ‰è¿è¡Œä¸­çš„å®¹å™¨
            if [ "$(docker ps -q)" ]; then
              docker stop $(docker ps -q)
              echo "å·²åœæ­¢æ‰€æœ‰è¿è¡Œä¸­çš„Dockerå®¹å™¨"
            else
              echo "æ²¡æœ‰è¿è¡Œä¸­çš„Dockerå®¹å™¨"
            fi

            # æ¸…ç†åœæ­¢çš„å®¹å™¨
            # docker container prune -f

      # 8. éƒ¨ç½²å‰ç«¯é™æ€æ–‡ä»¶
      - name: éƒ¨ç½²å‰ç«¯é™æ€æ–‡ä»¶åˆ°æœåŠ¡å™¨
        uses: appleboy/scp-action@v0.1.7
        with:
          host: 47.102.108.122
          username: root
          key: ${{ secrets.SERVER_SSH_PRIVATE_KEY }}
          source: 'packages/frontend/dist/*'
          target: '/opt/prisma-ai-hub-deploy/'
          strip_components: 0
          overwrite: true

      # 9. å¯åŠ¨æœåŠ¡
      - name: å¯åŠ¨DockeræœåŠ¡
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 47.102.108.122
          username: root
          key: ${{ secrets.SERVER_SSH_PRIVATE_KEY }}
          script: |
            echo "æ­£åœ¨å¯åŠ¨DockeræœåŠ¡..."
            cd /opt/prisma-ai-hub-deploy

            # å¯åŠ¨æœåŠ¡
            docker compose -f ./compose.CD.yaml up --build -d

            echo "DockeræœåŠ¡å¯åŠ¨å®Œæˆ"

            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 30

            # æ£€æŸ¥æœåŠ¡çŠ¶æ€
            docker ps

      # 10. å¥åº·æ£€æŸ¥å¹¶æ¢å¤åœ¨çº¿çŠ¶æ€
      - name: å¥åº·æ£€æŸ¥å¹¶æ¢å¤æœåŠ¡çŠ¶æ€
        run: |
          echo "æ­£åœ¨è¿›è¡Œå¥åº·æ£€æŸ¥..."

          # ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨
          sleep 60

          # æ£€æŸ¥ç½‘ç«™æ˜¯å¦å¯è®¿é—®
          MAX_RETRY=10
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRY ]; do
            if curl -s -f "https://pinkprisma.com/api/health" > /dev/null; then
              echo "ç½‘ç«™å¥åº·æ£€æŸ¥é€šè¿‡"
              break
            fi
            
            echo "å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œé‡è¯•ä¸­... ($((RETRY_COUNT + 1))/$MAX_RETRY)"
            sleep 10
            RETRY_COUNT=$((RETRY_COUNT + 1))
          done

          if [ $RETRY_COUNT -ge $MAX_RETRY ]; then
            echo "å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œä½†ç»§ç»­æ¢å¤æœåŠ¡çŠ¶æ€"
          fi

          # ç™»å½•å¹¶æ¢å¤åœ¨çº¿çŠ¶æ€
          echo "æ­£åœ¨æ¢å¤ç½‘ç«™åœ¨çº¿çŠ¶æ€..."

          LOGIN_RESPONSE=$(curl -s -X POST "https://pinkprisma.com/api/auth/login" \
            -H "Content-Type: application/json" \
            -d '{
              "email": "${{ secrets.WEBSITE_LOGIN_EMAIL }}",
              "password": "${{ secrets.WEBSITE_LOGIN_PASSWORD }}"
            }')

          TOKEN=$(echo $LOGIN_RESPONSE | jq -r '.data.token')

          if [ "$TOKEN" != "null" ] && [ -n "$TOKEN" ]; then
            # æ¢å¤åœ¨çº¿çŠ¶æ€
            curl -s -X PUT "https://pinkprisma.com/api/manage/service/status" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $TOKEN" \
              -d '{"status": "online"}'
              
            echo "ç½‘ç«™å·²æ¢å¤åœ¨çº¿çŠ¶æ€"
          else
            echo "æ— æ³•ç™»å½•ï¼Œè¯·æ‰‹åŠ¨æ¢å¤ç½‘ç«™åœ¨çº¿çŠ¶æ€"
          fi

      # 11. éƒ¨ç½²å®Œæˆé€šçŸ¥
      - name: éƒ¨ç½²å®Œæˆ
        run: |
          echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
          echo "ç½‘ç«™åœ°å€: https://pinkprisma.com"
          echo "è¯·éªŒè¯ç½‘ç«™åŠŸèƒ½æ˜¯å¦æ­£å¸¸"
